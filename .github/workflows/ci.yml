name: ğŸ”„ Continuous Integration

on:
  push:
    branches: ["main"]
    paths-ignore:
      - "docs/**"
      - "*.md"
      - ".gitignore"
  pull_request:
    branches: ["main"]
    paths-ignore:
      - "docs/**"
      - "*.md"
      - ".gitignore"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  GO_VERSION: "1.24.5"

jobs:
  # ===================================
  # Code Quality & Linting
  # ===================================
  quality:
    name: ğŸ” Code Quality
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ğŸ“‚ Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: ğŸ¹ Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: ğŸ“¥ Download dependencies
        run: go mod download

      - name: ğŸ§¹ Run gofmt
        run: |
          if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
            echo "âŒ Code is not formatted:"
            gofmt -s -l .
            exit 1
          fi
          echo "âœ… Code is properly formatted"

      - name: ğŸ” Run go vet
        run: go vet ./...

      - name: ğŸ“Š Run golangci-lint
        uses: golangci/golangci-lint-action@v8
        with:
          version: latest

      - name: ğŸ“ Run markdownlint
        uses: DavidAnson/markdownlint-cli2-action@v20
        with:
          globs: "**/*.md"

  # ===================================
  # Security Scanning
  # ===================================
  security:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ğŸ“‚ Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: ğŸ¹ Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: ğŸ”’ Install Gosec
        run: go install github.com/securego/gosec/v2/cmd/gosec@latest

      - name: ğŸ”’ Run Gosec Security Scanner
        run: |
          gosec -fmt sarif -out gosec.sarif ./...

      - name: ğŸ“‹ Upload SARIF file
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: gosec.sarif

  # ===================================
  # Build & Test Matrix
  # ===================================
  test:
    name: ğŸ§ª Test
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        # os: [ubuntu-latest, macos-latest, windows-latest]
        go-version: ["1.24.5"]

    steps:
      - name: ğŸ“‚ Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: ğŸ¹ Set up Go ${{ matrix.go-version }}
        uses: actions/setup-go@v6
        with:
          go-version: ${{ matrix.go-version }}
          cache: true

      - name: ğŸ“¥ Download dependencies
        run: go mod download

      - name: âœ… Verify dependencies
        run: go mod verify

      - name: ğŸ”¨ Build project
        run: CGO_ENABLED=0 go build -v ./...

      - name: ğŸ§ª Run tests
        run: go test -v -coverprofile=coverage.out ./...

      - name: ğŸ“Š Upload coverage to Codecov
        if: matrix.os == 'ubuntu-latest' && matrix.go-version == '1.24.5'
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage.out
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  # ===================================
  # Build Validation
  # ===================================
  build:
    name: ğŸ”¨ Build Validation
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [quality, security]

    steps:
      - name: ğŸ“‚ Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: ğŸ¹ Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: ğŸ“¥ Download dependencies
        run: go mod download

      - name: ğŸ”¨ Build for multiple architectures
        run: |
          # Linux
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o dist/yap-linux-amd64 ./cmd/yap
          CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -o dist/yap-linux-arm64 ./cmd/yap

          # # macOS
          # CGO_ENABLED=0 GOOS=darwin GOARCH=amd64 go build -o dist/yap-darwin-amd64 ./cmd/yap
          # CGO_ENABLED=0 GOOS=darwin GOARCH=arm64 go build -o dist/yap-darwin-arm64 ./cmd/yap

          # # Windows
          # CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build -o dist/yap-windows-amd64.exe ./cmd/yap

          echo "âœ… Multi-architecture build successful"

      - name: ğŸ§ª Test built binaries
        run: |
          ./dist/yap-linux-amd64 version
          echo "âœ… Binary execution test passed"

      - name: ğŸ“¦ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: dist/
          retention-days: 7

  # ===================================
  # Integration Tests
  # ===================================
  integration:
    name: ğŸ”— Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [build]
    if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository

    services:
      docker:
        image: docker:dind
        options: --privileged

    steps:
      - name: ğŸ“‚ Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: ğŸ¹ Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ“¥ Download build artifacts
        uses: actions/download-artifact@v5
        with:
          name: build-artifacts
          path: dist/

      - name: ğŸ”§ Make binaries executable
        run: chmod +x dist/*

      - name: ğŸ§ª Run integration tests
        run: |
          # Test example PKGBUILD if available
          if [ -f examples/yap/PKGBUILD ]; then
            echo "ğŸ§ª Testing example build..."
            cd examples/yap
            timeout 300 ../../dist/yap-linux-amd64 build . || echo "âš ï¸ Integration test completed with warnings"
            cd ../..
          fi

  # ===================================
  # Documentation Generation
  # ===================================
  docs:
    name: ğŸ“š Documentation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: ğŸ“‚ Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: ğŸ¹ Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: ğŸ“š Generate documentation
        run: |
          make doc-deps
          make doc-generate

      - name: ğŸ“¤ Upload documentation artifacts
        uses: actions/upload-artifact@v4
        with:
          name: documentation
          path: docs/api/
          retention-days: 30

  # ===================================
  # Summary Job
  # ===================================
  ci-success:
    name: âœ… CI Success
    runs-on: ubuntu-latest
    needs: [quality, security, test, build, integration, docs]
    if: always()

    steps:
      - name: ğŸ‰ All jobs completed
        run: |
          if [[ "${{ needs.quality.result }}" == "success" && \
                "${{ needs.security.result }}" == "success" && \
                "${{ needs.test.result }}" == "success" && \
                "${{ needs.build.result }}" == "success" && \
                ("${{ needs.integration.result }}" == "success" || "${{ needs.integration.result }}" == "skipped") && \
                ("${{ needs.docs.result }}" == "success" || "${{ needs.docs.result }}" == "skipped") ]]; then
            echo "ğŸ‰ All CI jobs completed successfully!"
            exit 0
          else
            echo "âŒ Some CI jobs failed"
            exit 1
          fi
